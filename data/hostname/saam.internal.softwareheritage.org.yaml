---
backups::exclude:
  - annex
  - data
  - mnt
  - srv/softwareheritage/annex
  - srv/softwareheritage/objects-xfs

# Deploy the storage server as a public resource
swh::deploy::storage::backend::listen::host: 0.0.0.0
swh::deploy::storage::backend::workers: 128
swh::deploy::storage::backend::max_requests: 5000
swh::deploy::storage::backend::max_requests_jitter: 500

swh::deploy::storage::legacy_directory: /srv/softwareheritage/objects-xfs

swh::deploy::storage::config:
  storage:
    cls: local
    args:
      db: "host=%{hiera('swh::deploy::storage::db::host')} user=%{hiera('swh::deploy::storage::db::user')} dbname=%{hiera('swh::deploy::storage::db::dbname')} password=%{hiera('swh::deploy::storage::db::password')}"
      objstorage:
        cls: multiplexer
        args:
          objstorages:
            - cls: pathslicing
              args:
                root: "%{hiera('swh::deploy::storage::directory')}"
                slicing: "0:2/0:5"
                compression: none
            - cls: filtered
              args:
                storage_conf:
                  cls: pathslicing
                  args:
                    root: "%{hiera('swh::deploy::storage::legacy_directory')}"
                    slicing: "0:1/0:2/2:4/4:6"
                    compression: gzip
                filters_conf:
                  - type: readonly
            - "%{alias('swh::remote_service::objstorage::config::azure')}"
      journal_writer:
        cls: kafka
        args:
          brokers: "%{alias('swh::deploy::journal::brokers')}"
          prefix: "%{alias('swh::deploy::journal::prefix')}"
          client_id: "swh.storage.journal_writer.%{::swh_hostname.short}"
          anonymize: true
          producer_config:
            message.max.bytes: 1000000000

# Deploy the indexer storage server as a public resource
swh::deploy::indexer::storage::backend::listen::host: 0.0.0.0
swh::deploy::indexer::storage::backend::workers: 32
swh::deploy::indexer::storage::config:
  indexer_storage:
    cls: local
    db: "host=%{hiera('swh::deploy::indexer::storage::db::host')} port=%{hiera('swh::deploy::indexer::storage::db::port')} user=%{hiera('swh::deploy::indexer::storage::db::user')} dbname=%{hiera('swh::deploy::indexer::storage::db::dbname')} password=%{hiera('swh::deploy::indexer::storage::db::password')}"

# open objstorage api
swh::deploy::objstorage::backend::listen::host: 0.0.0.0
swh::deploy::objstorage::backend::workers: 16
swh::deploy::objstorage::config:
  objstorage:
    cls: multiplexer
    args:
      objstorages:
        - cls: pathslicing
          args:
            root: "%{hiera('swh::deploy::storage::directory')}"
            slicing: "0:2/0:5"
            compression: none
        - cls: filtered
          args:
            storage_conf:
              cls: pathslicing
              args:
                root: "%{hiera('swh::deploy::storage::legacy_directory')}"
                slicing: "0:1/0:2/2:4/4:6"
                compression: gzip
            filters_conf:
              - type: readonly
  client_max_size: 1073741824  # 1 GiB

icinga2::host::vars:
  load: high
  disks:
    disk /srv/softwareheritage/objects-xfs/0:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/1:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/2:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/3:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/4:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/5:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/6:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/7:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/8:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/9:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/a:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/b:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/c:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/d:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/e:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'
    disk /srv/softwareheritage/objects-xfs/f:
      disk_units: 'GB'
      disk_wfree: '100'
      disk_cfree: '50'

nginx::worker_processes: 32

swh::apt_config::enable_non_free: true
packages:
  - intel-microcode
