---
swh::deploy::environment: staging

swh::deploy::worker::loader_nixguix::loglevel: debug

swh::deploy::storage::db::host: db0.internal.staging.swh.network
swh::deploy::storage::db::user: swh
swh::deploy::storage::db::dbname: swh

swh::deploy::indexer::storage::db::host: db0.internal.staging.swh.network
swh::deploy::indexer::storage::db::user: swh-indexer
swh::deploy::indexer::storage::db::dbname: swh-indexer

swh::deploy::scheduler::db::host: db0.internal.staging.swh.network
swh::deploy::scheduler::db::dbname: swh-scheduler
swh::deploy::scheduler::db::user: swh-scheduler

swh::deploy::deposit::db::host: deposit.internal.staging.swh.network
swh::deploy::deposit::db::dbuser: swh-deposit
swh::deploy::deposit::db::dbname: swh-deposit

swh::deploy::vault::db::host: db0.internal.staging.swh.network
swh::deploy::vault::db::user: swh-vault
swh::deploy::vault::db::dbname: swh-vault

swh::deploy::worker::lister::db::host: db0.internal.staging.swh.network
swh::deploy::worker::lister::db::user: swh-lister
swh::deploy::worker::lister::db::name: swh-lister

swh::deploy::worker::instances:
  - checker_deposit
  - loader_archive
  - loader_cran
  - loader_debian
  - loader_deposit
  - loader_nixguix
  - loader_git
  - loader_mercurial
  - loader_npm
  - loader_pypi
  - loader_svn
  - vault_cooker
  - lister
  - indexer_origin_intrinsic_metadata

#### Rabbitmq instance to use
# swh::deploy::worker::task_broker::password in private data
swh::deploy::worker::task_broker: "amqp://swhconsumer:%{hiera('swh::deploy::worker::task_broker::password')}@scheduler0.internal.staging.swh.network:5672/%2f"

#### Storage/Indexer/Vault/Scheduler services to use in staging area

swh::remote_service::storage::config::storage0:
  cls: remote
  args:
    url: "http://storage0.internal.staging.swh.network:%{hiera('swh::remote_service::storage::port')}/"
swh::remote_service::storage::config: "%{alias('swh::remote_service::storage::config::storage0')}"
swh::remote_service::storage::config::writable: &swh_remote_service_storage_config_writable
  "%{alias('swh::remote_service::storage::config::storage0')}"

swh::remote_service::vault::config::vault0:
  cls: remote
  args:
    url: "http://vault.internal.staging.swh.network:%{hiera('swh::remote_service::vault::port')}/"
swh::remote_service::vault::config: "%{alias('swh::remote_service::vault::config::vault0')}"
swh::remote_service::vault::config::writable: "%{alias('swh::remote_service::vault::config::vault0')}"

swh::remote_service::indexer::config::storage0:
  cls: remote
  url: "http://storage0.internal.staging.swh.network:%{hiera('swh::remote_service::indexer::port')}/"
swh::remote_service::indexer::config: "%{alias('swh::remote_service::indexer::config::storage0')}"
swh::remote_service::indexer::config::writable: "%{alias('swh::remote_service::indexer::config::storage0')}"

swh::remote_service::scheduler::config::scheduler0:
  cls: remote
  args:
    url: "http://scheduler0.internal.staging.swh.network:%{hiera('swh::remote_service::scheduler::port')}/"

swh::remote_service::scheduler::config: "%{alias('swh::remote_service::scheduler::config::scheduler0')}"
swh::remote_service::scheduler::config::writable: "%{alias('swh::remote_service::scheduler::config::scheduler0')}"

swh::deploy::deposit::url: http://deposit.internal.staging.swh.network

# do not save pack
swh::deploy::worker::loader_git::save_data_path: ""
swh::deploy::worker::loader_git::concurrency: 1

zookeeper::clusters:
  rocquencourt:
    '1': journal0.internal.staging.swh.network

kafka::clusters:
  rocquencourt:
    zookeeper::chroot: '/kafka/softwareheritage'
    zookeeper::servers:
      - journal0.internal.staging.swh.network
    brokers:
      journal0.internal.staging.swh.network:
        id: 1

swh::deploy::journal::brokers:
  - journal0.internal.staging.swh.network

swh::deploy::deposit::vhost::letsencrypt_cert: deposit_staging
swh::deploy::webapp::vhost::letsencrypt_cert: archive_staging

swh::postgresql::version: '12'
swh::postgresql::port: 5433
swh::postgresql::cluster_name: "%{lookup('swh::postgresql::version')}/main"
swh::postgresql::datadir: "%{lookup('swh::base_directory')}/postgresql/%{lookup('swh::postgresql::cluster_name')}"
swh::postgresql::listen_addresses:
  - localhost
  - 0.0.0.0
swh::postgresql::network_accesses:
  - 192.168.100.0/24 # Monitoring
  - 192.168.130.0/24 # Staging services

swh::postgresql::shared_buffers: 32GB

postgresql::server::config_entries:
  shared_buffers: "%{alias('swh::postgresql::shared_buffers')}"
  cluster_name: "%{alias('swh::postgresql::cluster_name')}"

postgresql::globals::version: "%{alias('swh::postgresql::version')}"

swh::dbs:
  storage:
    name: swh
    user: swh
  scheduler:
    name: swh-scheduler
    user: swh-scheduler
  vault:
    name: swh-vault
    user: swh-vault
  lister:
    name: swh-lister
    user: swh-lister
  deposit:
    name: swh-deposit
    user: swh-deposit
  indexer::storage:
    name: swh-indexer
    user: swh-indexer

pgbouncer::auth_hba_file: "/etc/postgresql/%{lookup('swh::postgresql::cluster_name')}/pg_hba.conf"
pgbouncer::listen_addr: 0.0.0.0
pgbouncer::databases:
  - source_db: swh
    host: localhost
    auth_user: postgres
    port: 5433
    alias: staging-swh
  - source_db: swh-scheduler
    host: localhost
    auth_user: postgres
    port: 5433
    alias: staging-swh-scheduler
  - source_db: swh-vault
    host: localhost
    auth_user: postgres
    port: 5433
    alias: staging-swh-vault
  - source_db: swh-lister
    host: localhost
    auth_user: postgres
    port: 5433
    alias: staging-swh-lister
  - source_db: swh-deposit
    host: localhost
    auth_user: postgres
    port: 5433
    alias: staging-swh-deposit
  - source_db: swh-indexer
    host: localhost
    auth_user: postgres
    port: 5433
    alias: staging-swh-indexer
